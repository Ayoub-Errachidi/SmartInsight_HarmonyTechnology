{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataSet - SmartInsight</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="{% static 'css/styles_statistiques.css' %}">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <a href="#" class="logo">
            <i class='bx bx-stats'></i>
            <div class="logo-name"><span>Smart</span>Insight</div>
        </a>

        <ul class="side-menu">
            <li><a href="{% url 'dashboard' %}"><i class='bx bxs-dashboard'></i>Import a file</a></li>
            <li><a href="{% url 'informations_dataset' %}"><i class='bx bxs-color'></i>Dashboard</a></li>
            <li><a href="{% url 'dataset' %}"><i class='bx bx-data'></i>DataSet</a></li>
            <li class="active"><a href="{% url 'statistiques' %}"><i class='bx  bx-bar-chart'></i>Statistics</a></li>
            <li><a href="{% url 'visualisations' %}"><i class='bx bx-scatter-chart' ></i>Visualization</a></li>
            <li><a href="{% url 'pretraitement_complet' %}"><i class='bx bx-message-square-dots'></i>Full cleaning</a></li>
        </ul>
    </div>
    <!-- End of Sidebar -->

    <!-- Main Content -->
    <div class="content">
        <!-- Navbar -->
        <nav>
            <i class='bx bx-menu'></i>
            <form action="#">
                <div class="form-input">
                    <input type="search" placeholder="Search...">
                    <button class="search-btn" type="submit"><i class='bx bx-search'></i></button>
                </div>
            </form>
            <input type="checkbox" id="theme-toggle" hidden>
            <label for="theme-toggle" class="theme-toggle"></label>
            <a href="#" class="notif">
                <i class='bx bx-bell'></i>
                <span class="count">12</span>
            </a>
            <a href="#" class="profile">
                <img src="{% static 'images/111.png' %}">
            </a>
        </nav>
        <!-- End of Navbar -->

        <main>
            <header class="page-header">Statistiques des Donn√©es Import√©es</header>

            {% if error %}
                <div class="table-card" style="background:#fdecea; color:#c62828; border-left:6px solid #ef5350;">
                    {{ error }}
                </div>
            {% else %}

            <!-- -------------------- Statistiques de base -------------------- -->
            {% if stats_base %}
            <div class="table-card">
                <h4>1. Statistiques descriptives (variables num√©riques)</h4>
                <div class="dataset-table-container" style="color: black;">
                    {{ stats_base|safe }}
                </div>
            </div>

            <!------- Explications IA ------->
            <div class="explanations">
                <h2> Explication AI pour Statistiques Descriptives </h2>

                {%for col, values in stats_base_dict.items %}
                    <div class="explanation-item">
                        <h3>Statistiques Descriptives Pour <span style="font-weight: bold; color: rebeccapurple ;text-decoration: underline;">{{ col }}</span></h3>
                        <p id="explanation-{{ forloop.counter }}"
                        data-variable="{{ col }}"
                        data-values="count: {{ values.count }}, mean: {{ values.mean }}, std: {{ values.std }}, min: {{ values.min }}, q1: {{ values.q1 }}, median: {{ values.median }}, q3: {{ values.q3 }}, max: {{ values.max }}">
                        Cliquez pour g√©n√©rer une explication personnalis√©e.
                        </p>

                        <!-- Bouton centr√© uniquement -->
                        <div class="btn-wrapper">
                            <button class="btn btn-ai-explain" 
                                data-section = "Stats_Desc"
                                data-target-id = "explanation-{{ forloop.counter }}">
                                G√©n√©rer l'explication IA
                            </button>
                            <button class="btn btn-ai-stop"
                                data-target-id = "explanation-{{ forloop.counter }}"
                                style="margin-left: 10px; display: none;">
                                Stop explication IA
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- -------------------- Statistiques avanc√©es -------------------- -->
            {% if stats_adv %}
            <div class="table-card">
                <h4>2. Statistiques avanc√©es</h4>
                <div class="dataset-table-container">
                    {{ stats_adv|safe }}
                </div>
            </div>

            <!------- Explications IA ------->
            <div class="explanations">
                <h2> Explication AI pour Statistiques Avanc√©es </h2>

                {%for col, values in stats_base_dict.items %}
                    <div class="explanation-item">
                        <h3>Statistiques Avanc√©es Pour <span style="font-weight: bold; color: rebeccapurple ;text-decoration: underline;">{{ col }}</span></h3>
                        <p id="explanation-adv-{{ forloop.counter }}"
                          data-variable="{{ col }}"
                          data-values="m√©diane: {{ values.median }}, variance: {{ values.variance }}, std: {{ values.std }}, coef_var: {{ values.coef_var }}, skewness: {{ values.skewness }}, kurtosis: {{ values.kurtosis }}">
                          Cliquez pour g√©n√©rer une explication IA sur la distribution.
                        </p>

                        <!-- Bouton centr√© uniquement -->
                        <div class="btn-wrapper">
                            <button class="btn btn-ai-explain" 
                                data-section = "Stats_adv"
                                data-target-id = "explanation-adv-{{ forloop.counter }}">
                                G√©n√©rer l'explication IA
                            </button>
                            <button class="btn btn-ai-stop"
                                data-target-id = "explanation-adv-{{ forloop.counter }}"
                                style="margin-left: 10px; display: none;">
                                Stop explication IA
                            </button>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% endif %}
            

            <!-- -------------------- Statistiques textuelles -------------------- -->
            {% if stats_text %}
            <div class="table-card">
                <h4>3. Analyse des variables textuelles</h4>

                <h5>3.1 Valeurs uniques</h5>
                <div class="dataset-table-container">{{ stats_text.unique_values|safe }}</div>

                <!------- Explications IA ------->
                <div class="explanations">
                    <h2> Explication AI pour Variables Textuelles </h2>
                    <div class="explanation-item">
                        <h3> Valeurs Uniques </h3>
                        <p id="explanation-text-unique"
                            data-section="Text_Unique"
                            data-values="{{ stats_text_dict }}">
                            Cliquez pour g√©n√©rer une explication IA des valeurs uniques.
                        </p>

                        <!-- Bouton centr√© uniquement -->
                        <div class="btn-wrapper">
                            <button class="btn btn-ai-explain" 
                                data-target-id="explanation-text-unique"
                                data-section="Text_Unique">
                                G√©n√©rer l'explication IA
                            </button>
                            <button class="btn btn-ai-stop"
                                data-target-id = "explanation-text-unique"
                                style="margin-left: 10px; display: none;">
                                Stop explication IA
                            </button>
                        </div>
                    </div>
                </div>


                <h5>3.2 Fr√©quence des valeurs les plus courantes</h5>
                <div class="dataset-table-container">{{ stats_text.top_values|safe }}</div>

                <!------- Explications IA ------->
                <div class="explanations">
                    <h2> Explication AI pour Variables Textuelles </h2>
                    <div class="explanation-item">
                        <h3> Valeurs les Plus Fr√©quentes </h3>
                        <p id="explanation-text-top"
                            data-section="Text_Top"
                            data-values="{{ top_values_dict | safe }}">
                            Cliquez pour g√©n√©rer une explication IA des valeurs les plus fr√©quentes.
                        </p>

                        <!-- Bouton centr√© uniquement -->
                        <div class="btn-wrapper">
                            <button class="btn btn-ai-explain" 
                                data-target-id="explanation-text-top"
                                data-section="Text_Top">
                                G√©n√©rer l'explication IA
                            </button>
                            <button class="btn btn-ai-stop"
                                data-target-id = "explanation-text-top"
                                style="margin-left: 10px; display: none;">
                                Stop explication IA
                            </button>
                        </div>
                    </div>
                </div>

                <h5>3.3 Nombre moyen de mots</h5>
                <div class="dataset-table-container">{{ stats_text.avg_word_count|safe }}</div>

                <!------- Explications IA ------->
                <div class="explanations">
                    <h2> Explication AI pour Variables Textuelles </h2>
                    <div class="explanation-item">
                        <h3> Nombre Moyen de Mots </h3>
                        <p id="explanation-text-wordcount"
                            data-section="Text_WordCount"
                            data-values="{{ stats_text.avg_word_count | striptags }}"
                            data-values1="{{ stats_text_dict }}">
                            Cliquez pour g√©n√©rer une explication IA du nombre moyen de mots.
                        </p>

                        <!-- Bouton centr√© uniquement -->
                        <div class="btn-wrapper">
                            <button class="btn btn-ai-explain"
                                data-target-id="explanation-text-wordcount"
                                data-section="Text_WordCount">
                                G√©n√©rer l'explication IA
                            </button>
                            <button class="btn btn-ai-stop"
                                data-target-id ="explanation-text-wordcount"
                                style="margin-left: 10px; display: none;">
                                Stop explication IA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- -------------------- Valeurs manquantes -------------------- -->
            {% if missing_values %}
            <div class="table-card">
                <h4>4. Valeurs manquantes</h4>
                <div class="dataset-table-container">
                    {{ missing_values|safe }}
                </div>
            </div>
            {% endif %}

            <!-- -------------------- Valeurs aberrantes -------------------- -->
            {% if outliers %}
            <div class="table-card">
                <h4>5. Valeurs aberrantes (Outliers)</h4>
                <div class="dataset-table-container">
                    {{ outliers|safe }}
                </div>

                {% if has_outliers %}
                    <div class="action-buttons" style="text-align: center; margin-top: 20px;">
                        <a href="{% url 'nettoyer_outliers' %}" class="btn-outline">Nettoyer les valeurs aberrantes</a>
                    </div>
                {% endif %}

            </div>
            {% endif %}

            <!-- -------------------- PCA -------------------- 

            {% if pca_html %}
            <div class="table-card">
                <h4>6. Analyse en Composantes Principales (PCA)</h4>
                <div class="dataset-table-container">
                    {{ pca_html|safe }}
                </div>
            </div>
            {% endif %}

            -->

            {% endif %}          
        </main>
    </div>

    <script src="{% static 'js/dashboard.js' %}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const tables = document.querySelectorAll("table");
            tables.forEach(table => {
            table.classList.add("dataset-table");
            });
        });
    </script>

    <script type="module">
      import { formatAIChunk } from "/static/js/ai_formatter.js";

      document.querySelectorAll('.btn-ai-explain').forEach(button => {
        button.addEventListener('click', async function () {
          const targetId = button.getAttribute('data-target-id');
          const section = button.getAttribute('data-section');
          const el = document.getElementById(targetId);
          const stopButton = document.querySelector(`.btn-ai-stop[data-target-id="${targetId}"]`);


          // D√©finir le contr√¥leur pour stopper la lecture du flux
          let controller;
          let reader;
          let isStopped = false;

          // R√©cup√©ration des donn√©es personnalis√©es selon la section
          const variable = el.dataset.variable;
          const values = el.dataset.values;
          const values1 = el.dataset.values1;

          // Emp√™cher les clics multiples
          button.disabled = true;
          stopButton.style.display = 'inline-block';
          stopButton.disabled = false;

          // Construire dynamiquement le prompt
          let prompt = "";
          if (section === "Stats_Desc") {
            prompt = `Les statistiques descriptives de ce tableau : ${variable} : ${values}

            G√©n√®re une explication claire et simple en fran√ßais de ce que cela signifie.`;
          } else if (section === "Stats_adv") {
            prompt = `Voici des statistiques avanc√©es pour la variable "${variable}" : ${values}.

            Donne une explication claire et simple en fran√ßais sur ce que ces valeurs signifient (asym√©trie/skewness, aplatissement/kurtosis, coefficient de variation). 
            Explique s'il y a une forte dispersion ou une distribution non normale.`;
          } else if (section === "Text_Unique") {
            prompt = `Faire une Analyse des colonnes textuelles suivantes repr√©sent√©es sous forme de dictionnaire : ${values}.
            
            Pour chaque colonne :
            1. Fournis une explication concise et p√©dagogique sur sa nature.
            2. Donne nombre et Les valeurs uniques disponibles(Si existe plus que 20 Valeurs citer les 3 Premiers valeurs par exemple) en Fran√ßais.
            Ta r√©ponse doit √™tre claire en Fran√ßais, rapide √† lire et adapt√©e √† un usage professionnel.`;
          } else if (section === "Text_Top") {
            prompt = `Voici les valeurs textuelles les plus fr√©quentes : ${values}.

            Pour chaque colonne :
            1. Explique la valeur dominante (top) et son poids (freq) par rapport au total (count) pour d√©tecter les d√©s√©quilibres ou la pr√©dominance d'une modalit√©.
            2. Indique si la colonne semble homog√®ne ou h√©t√©rog√®ne, et si une valeur √©crase les autres (tendance forte).

            - Ta r√©ponse doit √™tre claire et rapide en fran√ßais.
            Donne une explication simple en fran√ßais sur les tendances ou d√©s√©quilibres possibles.`;
          } else if (section === "Text_WordCount") {
            prompt = `en fran√ßais, Voici le nombre moyen de mots pour chaque colonne : ${values}.
            - Les valeurs de chaque colonnes :  ${values1}.
             
            Pour chaque colonne :
            1. Citer tous les colonnes avec leur nombre moyen de mots avec explication pertinent et court des valeurs en fran√ßais.
            Explique ce que cela signifie en fran√ßais pour la qualit√© ou richesse des donn√©es textuelles.`;
          }


          let displayText = '';
          let timer = 0;
          const startTime = performance.now();

          el.innerHTML = '‚è±Ô∏è G√©n√©ration en cours : 0.0 sec';
          

          const timerId = setInterval(() => {
            const currentTime = ((performance.now() - startTime) / 1000).toFixed(1);
            el.innerHTML = displayText + `<br><br>‚è±Ô∏è G√©n√©ration en cours : ${currentTime} sec`;
          }, 100);

          const state = {
            isBold: false,
            boldBuffer: '',
            asteriskCount: 0
          };

          stopButton.addEventListener('click', () => {
            isStopped = true;
            if (controller) controller.abort(); // Stoppe la lecture
            clearInterval(timerId);
            el.innerHTML += `<br><br>üõë Explication arr√™t√©e par l'utilisateur.`;
            button.disabled = false;
            stopButton.style.display = 'none';
          }, { once: true }); // une seule fois pour √©viter conflits

          try {
            controller = new AbortController();
            const response = await fetch(`/stream_explanation/?prompt=${encodeURIComponent(prompt)}`, {
              signal: controller.signal
            });

            reader = response.body.getReader();
            const decoder = new TextDecoder();

            async function readChunk() {
              const { done, value } = await reader.read();
              if (done || isStopped) {
                clearInterval(timerId);
                const duration = ((performance.now() - startTime) / 1000).toFixed(2);
                if (!isStopped) el.innerHTML = displayText + `<br><br>‚úÖ Temps total : ${duration} sec`;
                button.disabled = false;
                stopButton.style.display = 'none';
                return;
              }

              const chunk = decoder.decode(value, { stream: true });
              const formattedChunk = formatAIChunk(chunk, state);
              displayText += formattedChunk;
              await readChunk();
            }

            await readChunk();
          } catch (error) {
            if (error.name !== 'AbortError') {
              console.error("Erreur IA :", error);
              el.textContent = "‚ùå Erreur lors de la g√©n√©ration de l'explication.";
            }
          } finally {
            button.disabled = false;
            stopButton.style.display = 'none';
            clearInterval(timerId);
          }
        });
      });
    </script>
    
</body>
</html>